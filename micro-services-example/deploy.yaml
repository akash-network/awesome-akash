---
version: "2.0"
services:
  carts:
    image: public.ecr.aws/aws-containers/retail-store-sample-cart:1.3.0
    expose:
      - port: 8080
        as: 8080
        proto: tcp
        to:
          - global: false
          - service: ui
    env:
      - SERVER_TOMCAT_ACCESSLOG_ENABLED=true
      - RETAIL_CART_PERSISTENCE_PROVIDER=dynamodb
      - RETAIL_CART_PERSISTENCE_DYNAMODB_ENDPOINT=http://carts-db:8000
      - RETAIL_CART_PERSISTENCE_DYNAMODB_CREATE_TABLE=true
      - AWS_ACCESS_KEY_ID=key
      - AWS_SECRET_ACCESS_KEY=dummy
  carts-db:
    image: amazon/dynamodb-local:1.20.0
    expose:
      - port: 8000
        as: 8000
        proto: tcp
        to:
          - global: false
          - service: carts
  catalog:
    image: public.ecr.aws/aws-containers/retail-store-sample-catalog:1.3.0
    expose:
      - port: 8080
        as: 8080
        proto: tcp
        to:
          - global: false
          - service: ui
    env:  
      - RETAIL_CATALOG_PERSISTENCE_DB_NAME=catalogdb  
      - RETAIL_CATALOG_PERSISTENCE_USER=catalog_user  
      - GIN_MODE=release
      - RETAIL_CATALOG_PERSISTENCE_PROVIDER=mysql
      - RETAIL_CATALOG_PERSISTENCE_PASSWORD=mypassword123
      - RETAIL_CATALOG_PERSISTENCE_ENDPOINT=catalog-db:3306
  catalog-db:
    image: mariadb:10.9
    expose:
      - port: 3306
        as: 3306
        proto: tcp
        to:
          - global: false
          - service: catalog
    env:
      - MYSQL_ROOT_PASSWORD=mypassword123
      - MYSQL_ALLOW_EMPTY_PASSWORD=true
      - MYSQL_DATABASE=catalogdb
      - MYSQL_USER=catalog_user
      - MYSQL_PASSWORD=mypassword123
  checkout:
    image: public.ecr.aws/aws-containers/retail-store-sample-checkout:1.3.0
    expose:
      - port: 8080
        as: 8080
        proto: tcp
        to:
          - global: false
          - service: ui
    env:
      - RETAIL_CHECKOUT_PERSISTENCE_PROVIDER=redis
      - RETAIL_CHECKOUT_PERSISTENCE_REDIS_URL=redis://checkout-redis:6379
      - RETAIL_CHECKOUT_ENDPOINTS_ORDERS=http://orders:8080
  checkout-redis:
    image: redis:6.0-alpine
    expose:
      - port: 6379
        as: 6379
        proto: tcp
        to:
          - global: false
          - service: checkout
  orders:
    image: public.ecr.aws/aws-containers/retail-store-sample-orders:1.3.0
    expose:
      - port: 8080
        as: 8080
        proto: tcp
        to:
          - global: false
          - service: ui
          - service: checkout
    env:
      - SERVER_TOMCAT_ACCESSLOG_ENABLED=true
      - RETAIL_ORDERS_PERSISTENCE_PROVIDER=postgres
      - RETAIL_ORDERS_PERSISTENCE_ENDPOINT=orders-db:5432
      - RETAIL_ORDERS_PERSISTENCE_NAME=orders
      - RETAIL_ORDERS_PERSISTENCE_USERNAME=orders_user
      - RETAIL_ORDERS_PERSISTENCE_PASSWORD=mypassword123
      - RETAIL_ORDERS_MESSAGING_PROVIDER=rabbitmq
      - RETAIL_ORDERS_MESSAGING_RABBITMQ_ADDRESSES=rabbitmq:5672
      - RETAIL_ORDERS_MESSAGING_RABBITMQ_USERNAME=rabbitmq
      - RETAIL_ORDERS_MESSAGING_RABBITMQ_PASSWORD=mypassword123
  orders-db:
    image: postgres:16.1
    expose:
      - port: 5432
        as: 5432
        proto: tcp
        to:
          - global: false
          - service: orders
    env:
      - POSTGRES_PASSWORD=mypassword123
      - POSTGRES_DB=orders
      - POSTGRES_USER=orders_user
  rabbitmq:
    image: rabbitmq:3-management
    expose:
      - port: 5672
        as: 5672
        proto: tcp
        to:
          - global: false
          - service: orders
    env:
      - RABBITMQ_DEFAULT_USER=rabbitmq
      - RABBITMQ_DEFAULT_PASS=mypassword123
  ui:
    image: public.ecr.aws/aws-containers/retail-store-sample-ui:1.3.0
    expose:
      - port: 8080
        as: 8080
        proto: tcp
        to:
          - global: true
    env:
      - SERVER_TOMCAT_ACCESSLOG_ENABLED=true
      - RETAIL_UI_ENDPOINTS_CATALOG=http://catalog:8080
      - RETAIL_UI_ENDPOINTS_CARTS=http://carts:8080
      - RETAIL_UI_ENDPOINTS_ORDERS=http://orders:8080
      - RETAIL_UI_ENDPOINTS_CHECKOUT=http://checkout:8080
profiles:
  compute:
    carts:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 512Mi
        storage:
          - size: 1Gi
    carts-db:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 256Mi
        storage:
          - size: 1Gi
    catalog:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 512Mi
        storage:
          - size: 1Gi
    catalog-db:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 512Mi
        storage:
          - size: 1Gi
    checkout:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 512Mi
        storage:
          - size: 1Gi
    checkout-redis:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 256Mi
        storage:
          - size: 1Gi
    orders:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 512Mi
        storage:
          - size: 1Gi
    orders-db:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 512Mi
        storage:
          - size: 2Gi
    rabbitmq:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 256Mi
        storage:
          - size: 1Gi
    ui:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 512Mi
        storage:
          - size: 1Gi
  placement:
    dcloud:
      pricing:
        carts:
          denom: uakt
          amount: 100000
        carts-db:
          denom: uakt
          amount: 100000
        catalog:
          denom: uakt
          amount: 100000
        catalog-db:
          denom: uakt
          amount: 100000
        checkout:
          denom: uakt
          amount: 100000
        checkout-redis:
          denom: uakt
          amount: 100000
        orders:
          denom: uakt
          amount: 100000
        orders-db:
          denom: uakt
          amount: 100000
        rabbitmq:
          denom: uakt
          amount: 100000
        ui:
          denom: uakt
          amount: 100000
deployment:
  carts:
    dcloud:
      profile: carts
      count: 1
  carts-db:
    dcloud:
      profile: carts-db
      count: 1
  catalog:
    dcloud:
      profile: catalog
      count: 1
  catalog-db:
    dcloud:
      profile: catalog-db
      count: 1
  checkout:
    dcloud:
      profile: checkout
      count: 1
  checkout-redis:
    dcloud:
      profile: checkout-redis
      count: 1
  orders:
    dcloud:
      profile: orders
      count: 1
  orders-db:
    dcloud:
      profile: orders-db
      count: 1
  rabbitmq:
    dcloud:
      profile: rabbitmq
      count: 1
  ui:
    dcloud:
      profile: ui
      count: 1
