---
version: "2.0"

endpoints: 
  nodeip:
    kind: ip

services:
  codex:
    image: codexstorage/nim-codex:0.1.6
    expose:
    - port: 8080
      as: 8080
      to:
        - global: true
          ip: nodeip
    - port: 8070
      as: 8070
      proto: tcp
      to:
        - global: true
          ip: nodeip
    - port: 8090
      as: 8090
      proto: udp
      to:
        - global: true
          ip: nodeip
    env:
      - DATA_DIR=/codex/data
      - PRIV_KEY=
      - CODEX_NAT=
      - CODEX_LOG_LEVEL=debug
    command:
    - sh
    - -c
    args:
    - >
        if [ -z "${CODEX_NAT}" ]; then
          echo "Missing \$CODEX_NAT=public_ip_of_the_deplyoment"
          sleep 120
          exit 1
        fi

        mkdir -p ${DATA_DIR}
        chmod 0700 ${DATA_DIR}

        exec /docker-entrypoint.sh codex \
          --bootstrap-node=spr:CiUIAhIhAiJvIcA_ZwPZ9ugVKDbmqwhJZaig5zKyLiuaicRcCGqLEgIDARo8CicAJQgCEiECIm8hwD9nA9n26BUoNuarCEllqKDnMrIuK5qJxFwIaosQ3d6esAYaCwoJBJ_f8zKRAnU6KkYwRAIgM0MvWNJL296kJ9gWvfatfmVvT-A7O2s8Mxp8l9c8EW0CIC-h-H-jBVSgFjg3Eny2u33qF7BDnWFzo7fGfZ7_qc9P \
          --storage-quota=11811160064 \
          --data-dir=${DATA_DIR} \
          --api-port=8080 \
          --api-bindaddr=0.0.0.0 \
          --disc-port=8090 \
          --listen-addrs=/ip4/0.0.0.0/tcp/8070 \
          persistence \
          --eth-provider=https://rpc.testnet.codex.storage \
          --marketplace-address=0xfE822Df439d987849a90B64a4C0e26a297DBD47F

    params:
      storage:
        codex:
          mount: /codex
          readOnly: false
 
profiles:
  compute:
    codex:
      resources:
        cpu:
          units: 2
        memory:
          size: 2Gi
        storage:
          - size: 1Gi
          - size: 10Gi
            name: codex
            attributes:
              persistent: true
              class: beta3
    
  placement:
    dcloud:
      pricing:
        codex:
          denom: uakt
          amount: 100000

deployment:
  codex:
    dcloud:
      profile: codex
      count: 1 


