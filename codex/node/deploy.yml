---
version: "2.0"

endpoints: 
  nodeip:
    kind: ip

services:
  codex:
    image: codexstorage/nim-codex:0.2.0
    expose:
#    - port: 8080 # You probably don't want to expose the API globally:) Consider using reverse proxy with some auth?
#      as: 8080
#      to:
#        - global: true
#          ip: nodeip
    - port: 8070
      as: 8070
      proto: tcp
      to:
        - global: true
          ip: nodeip
    - port: 8090
      as: 8090
      proto: udp
      to:
        - global: true
          ip: nodeip
    env:
      - DATA_DIR=/codex/data
      - ETH_PRIVATE_KEY=
      - PUBLIC_IP=
      - CODEX_LOG_LEVEL=debug
      - CODEX_BLOCK_TTL=30d 
    command:
    - sh
    - -c
    args:
    - >
        if [ -z "${PUBLIC_IP}" ]; then
          echo "Missing \$PUBLIC_IP=public_ip_of_the_deplyoment"
          sleep 120
          exit 1
        fi

        mkdir -p ${DATA_DIR}
        chmod 0700 ${DATA_DIR}

        quota=$(df --output=size --block-size=1 /codex | tail -1)

        BOOTSTRAP_NODES=$(for i in $(curl https://spr.codex.storage/testnet 2> /dev/null); do echo --bootstrap-node=${i}; done)

        exec /docker-entrypoint.sh codex \
          --storage-quota=${quota} \
          --data-dir=${DATA_DIR} \
          --api-port=8080 \
          --api-bindaddr=0.0.0.0 \
          --disc-port=8090 \
          --listen-addrs=/ip4/0.0.0.0/tcp/8070 \
          --nat=extip:${PUBLIC_IP}\
          ${BOOTSTRAP_NODES}\
          persistence \
          --eth-provider=https://rpc.testnet.codex.storage

    params:
      storage:
        codex:
          mount: /codex
          readOnly: false
 
profiles:
  compute:
    codex:
      resources:
        cpu:
          units: 2
        memory:
          size: 4Gi
        storage:
          - size: 1Gi
          - size: 10Gi
            name: codex
            attributes:
              persistent: true
              class: beta3
    
  placement:
    dcloud:
      pricing:
        codex:
          denom: uakt
          amount: 100000

deployment:
  codex:
    dcloud:
      profile: codex
      count: 1 


